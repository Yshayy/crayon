<html>
<head>
	<!-- CODE MIRROR START -->
    <script src="/codemirror/codemirror.js"></script>
    <script src="/codemirror/show-hint.js"></script>
    <script src="/codemirror/javascript-hint.js"></script>
    <script src="/codemirror/javascript.js"></script>
    <script src="/codemirror/jshint.js"></script>
    <script src="/codemirror/crayon-auto-complete.js"></script>
    <!-- CODE MIRROR END -->

	<script type="text/javascript" src="../../jquery-1.3.2.min.js"></script>	
	<script type="text/javascript" src="../../client-graphing.js"></script>
	<script type="text/javascript" src="../../client-querying.js"></script>
	<script type="text/javascript" src="../../dygraph-combined.js"></script>
	<script type="text/javascript" src="/beautify.js"></script>

</head>
<body>
<div id="pageBody" class="frameBody">
<table id="pageTable" cellSpacing="0" cellpadding="0" style="width:100%;">
	<tr>
		<td class="codemirrorTopBar" style="">
			<span class="crayonButton" onclick="updateUrl()"  style="margin-left:30px">Query</span>
			<span class="crayonButton" onclick="addSeries()"  style="margin-left:10px">Add/Remove Series</span>
			<span class="crayonButton" onclick="saveDashboard()"  style="margin-left:10px">Save</span>
		</td>
	</tr>
	<tr>
		<td>
			<textarea id="txtQuery"  class="textAreaWithLines" style="width:600; height:400px; resize:none; "></textarea>
		</td>
	</tr>
</table>

<div id="graphAndLegendDiv" style="display: none">
	<table cellSpacing="5" cellpadding="0" style="margin: 20px">
		<tr>
			<td><div id="graphDiv" style="width:600px; height:400px"></div></td>
			<td><div id="legendDiv" class="legendDiv" style="width:400px"></div></td>
		</tr>
	</table>
</div>

<!-- add series dialog -->
<div class="slidingOverlay" id="addSeriesDialog" style="left: -200px; top: 40px; width:300px; height: 400px;">
  <h2>Add series</h2>

  <p>
    Search series by name using regex:<br>
    <input id="matchRegex" style="width:240px"/><span class="crayonButton" onclick="searchSeries()" style="margin-left:10px">go</span>
  </p>

  <div id="matchBox" class="listBox" style="width:100%; height:250px;">
  	<table id='matchTable' class="listTable" style='border-collapse: separate;text-align: left;width:100%;'>

  	</table>
  </div>

  <!-- Buttons -->
  <p>
	<span class="crayonButton" onclick="addSeries_ok()" style="float:right;">OK</span>
	<span class="crayonButton" onclick="addSeries_cancel()" style="float:right;margin-right:10px">Cancel</span>
	<span class="crayonButton" onclick="addSeries_toggleAll()" style="float:left;">Toggle All</span>
  </p>
</div>

  <div id="autoCompleteDesc" style="display:none"></div>
</div>
<script type="text/javascript">
//<a href="http://dygraphs.com/options.html">Dygraph Reference</a></td>
// ===================================================================
// =================================================================== ADD SERIES DIALOG
// ===================================================================

$("#matchRegex").keyup(function(event){
    if(event.keyCode == 13){
        searchSeries();
    }
});

function searchSeries() {
	matchTable.innerHTML = "";
	var table = $("#matchTable");
	getMatchingSeriesNames(matchRegex.value, updateMatchingSeriesList);
}
function updateMatchingSeriesList(nameDocs) {
	var sb = "";
	var namesInList = {};
	for (nameIndex in graphToAddSeriesTo.names) {
		var name = graphToAddSeriesTo.names[nameIndex];
		namesInList[name] = 1;
		sb += "<tr class='listItemRow'><td class='listItemCellSelected' onclick='toggleSeriesInList(this)'>" + name + "</td></tr>";
	}

	for (nameDocIndex in nameDocs) {
		var nameDoc = nameDocs[nameDocIndex];
		if (namesInList[nameDoc.n]) continue;
		sb += "<tr class='listItemRow'><td class='listItemCell' onclick='toggleSeriesInList(this)'>" + nameDoc.n + "</td></tr>";
	}

	matchTable.innerHTML = sb;
}
function getMatchingSeriesNames(regex, callback) {
	if (regex == null || regex.trim() == "") {
		console.warn("Regex length must be at least one character long");
		return;
	}

	$.ajax({
		url: "/matchSeriesName",
		data: "limit=9999&regex=" + encodeURIComponent(regex),
		dataType: 'json',
		headers: { "Accept-Encoding" : "gzip" },
		success: function(resultObject) {
			if (resultObject.error) {
				console.error(resultObject.error);
			} else {
				callback(resultObject.names)
			}
		}
	});
}

function toggleSeriesInList(listItem) {
	if (listItem.className == "listItemCellSelected") {
		listItem.className = "listItemCell";
	} else {
		listItem.className = "listItemCellSelected";
	}
}

var graphToAddSeriesTo;
var dashboardToAddSeriesTo;
function updateJsonSeriesNames(tds) {
	var usedNames = {};

	for (i in tds) {
		var seriesName = tds[i].innerHTML;
		usedNames[seriesName] = 0;
	}

	var newNamesArr = [];
	for (name in usedNames) {
		if (!name) continue;
		newNamesArr.push(name);
	}
	graphToAddSeriesTo.names = newNamesArr;
	editor.setValue(js_beautify(JSON.stringify(dashboardToAddSeriesTo || graphToAddSeriesTo)));
}
function addSeries_toggleAll() {
	var tds = matchTable.getElementsByTagName("td");
	if (tds.length == 0) return;
	var newClass = (tds[0].className == "listItemCell" ? "listItemCellSelected" : "listItemCell")

	for (i in tds) {
		tds[i].className = newClass;
	}
}
function addSeries_ok() {
	var tds = $(".listItemCellSelected").get()
	updateJsonSeriesNames(tds);
	addSeries_close();
}
function addSeries_cancel() {
	addSeries_close();
}
function addSeries_close() {
	matchTable.innerHTML = "";
	$("#addSeriesDialog").css("left", "-200");
	setTimeout(function() {
		$("#addSeriesDialog").css("display", "none");
	}, 500);
}
function addSeries() {
	var args = editor.getValue();
	try {
		args = JSON.parse(args);
	} catch (ex) {
		alert('JSON must be valid before adding a series to it.\n' + ex);
		return;
	}

	if (args.graphs && args.graphs.length > 0) { 
		graphToAddSeriesTo = args.graphs[0];
		dashboardToAddSeriesTo = args;
	} else {
		graphToAddSeriesTo = args;
		dashboardToAddSeriesTo = null;
	}

	updateMatchingSeriesList([]);
	$("#addSeriesDialog").css("display", "block");
	setTimeout(function() {
		$("#addSeriesDialog").css("left", "180");
	}, 200);
}

// ===================================================================
// =================================================================== Page itself
// ===================================================================

CodeMirror.hintSelected = function(data, action, completion, el) {
	var innerHTML = staticAutoComplete[completion];
	var ulJQ = $(el).parent();
	var ulPos = ulJQ.position();
	var ulWidth = ulJQ.width();
	autoCompleteDesc.innerHTML = innerHTML;
	$("#autoCompleteDesc").css("top",ulPos.top);
	$("#autoCompleteDesc").css("left",ulPos.left + ulWidth + 7);
	$("#autoCompleteDesc").css("position","absolute");
	$("#autoCompleteDesc").css("display","block");
}

CodeMirror.hintingOver = function() {
	$("#autoCompleteDesc").css("display","none");
}

CodeMirror.commands.autocomplete = function(cm) {
	CodeMirror.showHint(cm,function() {
		var cur = editor.getCursor();
		var token = editor.getTokenAt(cur);
		//console.log(token);
		if (token.className == "string property" || token.className == "string") {
			var firstMatchIndex = 0;
		 	var autoCompleteList = [];
		 	CodeMirror.extraClass = {};
		 	var keys = Object.keys(staticAutoComplete);
		 	keys.sort();
		 	var effectiveKeyIndex = -1;
		 	for (keyIndex in keys) {
		 		effectiveKeyIndex++;
				var key = keys[keyIndex];

		 		// Apply type image
		 		var content = staticAutoComplete[key];
		 		var typeStart = content.indexOf("Type:");
		 		if (typeStart != -1) {
		 			var typeLine = content.substring(typeStart).split('<br>')[0];
		 			if (typeLine.indexOf("function") != -1) {
		 				effectiveKeyIndex--;
		 				CodeMirror.extraClass[key] = "imgFunction";

		 				// We're not allowing functions
		 				continue;
		 			} else if (typeLine.indexOf("string") != -1) {
		 				CodeMirror.extraClass[key] = "imgText";
					} else if (typeLine.indexOf("number") != -1) {
		 				CodeMirror.extraClass[key] = "imgNumber";
					} else if (typeLine.indexOf("integer") != -1) {
		 				CodeMirror.extraClass[key] = "imgNumber";	 				
		 			} else if (typeLine.indexOf("float") != -1) {
		 				CodeMirror.extraClass[key] = "imgNumber";
					} else if (typeLine.indexOf("boolean") != -1) {
		 				CodeMirror.extraClass[key] = "imgNumber";		 				
		 			} else {
		 				CodeMirror.extraClass[key] = "imgJavascript";
		 			}
		 		}

		 		if (firstMatchIndex == 0 && key.indexOf(token.string.replace(/["']/g,"")) == 0) {
		 			firstMatchIndex = effectiveKeyIndex;
		 		}

		 		autoCompleteList.push(key);
		 	}

			var start = token.start;
			var end = token.end;
		    if (token.string.length > 0) {
		    	if (token.string[0] == '"' || token.string[0] == "'") start++;
		    	if (token.string[token.string.length - 1] == '"' || token.string[token.string.length - 1] == "'") end--;
		    	if (end < start) end = start;
		    }
			return {
				list: autoCompleteList,
				from: CodeMirror.Pos(cur.line, start),
		        to: CodeMirror.Pos(cur.line, end),
		        selectedIndex: firstMatchIndex
			};
		}
	});
}
var editor = CodeMirror.fromTextArea(document.getElementById("txtQuery"), {
	lineNumbers: true,
	extraKeys: {"Ctrl-Space": "autocomplete"},
	viewportMargin: Infinity
});
function getCompletions(token, context) {
	return ["NoCompletions","NoneAtAll"];
}

var widgets = []
function updateHints() {
  editor.operation(function(){
    for (var i = 0; i < widgets.length; ++i)
      editor.removeLineWidget(widgets[i]);
    widgets.length = 0;

    JSHINT(editor.getValue());
    for (var i = 0; i < JSHINT.errors.length; ++i) {
      var err = JSHINT.errors[i];
      if (!err) continue;
      var msg = document.createElement("div");
      var icon = msg.appendChild(document.createElement("span"));
      icon.innerHTML = "!!";
      icon.className = "lint-error-icon";
      msg.appendChild(document.createTextNode(err.reason));
      msg.className = "lint-error";
      widgets.push(editor.addLineWidget(err.line - 1, msg, {coverGutter: false, noHScroll: true}));
      break;
    }
  });
  var info = editor.getScrollInfo();
  var after = editor.charCoords({line: editor.getCursor().line + 1, ch: 0}, "local").top;
  if (info.top + info.clientHeight < after)
    editor.scrollTo(null, after - info.clientHeight + 3);
}
var waiting;
  editor.on("change", function() {
    clearTimeout(waiting);
    waiting = setTimeout(updateHints, 500);
  });

setTimeout(updateHints, 100);

function saveDashboardOverwrite(dashboard) {
	console.log("Saving dashboard...");
	
	$.ajax({
		url: "/saveDashboard",
		data: js_beautify(JSON.stringify(dashboard)),
		dataType: "text",
		type: 'POST',
		success: function(result) {
			var resultObject = JSON.parse(result);
			if (resultObject.error) {
				showAlert({OK: true, title:"Save Failed", text:"Server Error: " + resultObject.error});
			} else {
				showAlert({OK: true, title:"Dashboard Saved", text:"Dashboard saved successfully"});
				window.reloadDashboardList();
			}
		}
	});
}

function saveDashboard() {
	var jsonString = editor.getValue();
  	var dashboard = JSON.parse(jsonString);
  	if (!dashboard.id) {
  		showAlert({OK: true, title:"Can't Save Yet", text:"Dashboard id attribute is missing or empty"});
	} else if (!dashboard.sidebarText) {
  		showAlert({OK: true, title:"Can't Save Yet", text:"Dashboard sidebarText attribute is missing or empty"});
  	} else if (dashboard.id.replace(/[a-zA-Z0-9_-]/g,"") != "") {
  		showAlert({OK: true, title:"Can't Save Yet", text:"Dashboard id invalid: Can contain only letters, digits and dashes"});
  	} else if (!dashboard.graphs || !dashboard.graphs.length) {
  		showAlert({OK: true, title:"Can't Save Yet", text:"Dashboard doesn't contain any graphs (use the graphs attribute)"});
  	} else if (dashboardIDs[dashboard.id] != null) {
  		showAlert({OK: true, Cancel: true, title:"Confirm Overwrite", text:"a Dashboard with the supplied id exists. Overwrite?", callback: 
			function(choice) {
				if (choice == "OK") {
					saveDashboardOverwrite(dashboard);
				}
			}});
  	} else {
  		saveDashboardOverwrite(dashboard);
  	}
	//dashboardIDs
}


function updateUrl() {
  var jsonString = editor.getValue();
  var newQueryArgs = JSON.parse(jsonString);
  var query="?dummy=1";

  try {if (newQueryArgs.from) query += "&from=" + newQueryArgs.from; } catch (ex) {}
  try {if (newQueryArgs.to) query += "&to=" + newQueryArgs.to; } catch (ex) {}
  try {if (newQueryArgs.unit) query += "&unit=" + newQueryArgs.unit; } catch (ex) {}
  try {if (newQueryArgs.names) query += "&names=" + JSON.stringify(newQueryArgs.names); } catch (ex) {}
  try {if (newQueryArgs.components) query += "&components=" + JSON.stringify(newQueryArgs.components); } catch (ex) {}
  try {if (newQueryArgs.server) query += "&server=" + JSON.stringify(newQueryArgs.server); } catch (ex) {}
  try {if (newQueryArgs.graphOpts) query += "&graphOpts=" + encodeURIComponent(JSON.stringify(newQueryArgs.graphOpts)); } catch (ex) {}
  
  //var win=window.open(window.location.origin + "/designer_ui.html" + query, '_blank');
  //win.focus();

  var win=window.open(window.location.origin + "/by-json.html?dashboard=" + encodeURIComponent(jsonString), '_blank');
  win.focus();
}

var queryArgs = {};
(function () {
	var match,
		pl     = /\+/g,  // Regex for replacing addition symbol with a space
		search = /([^&=]+)=?([^&]*)/g,
		decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
		query  = window.location.toString().split("?")[1]||"";

	while (match = search.exec(query))
	   queryArgs[decode(match[1])] = decode(match[2]);
})();

var plotGraph = function(allGraphData) {  
	var graphDiv = $("#graphDiv").get()[0];
	var legendDiv = $("#legendDiv").get()[0];
	allGraphData.sort(function (g1,g2) { return (g1.time < g2.time ? -1 : 1) });

	var args = editor.getValue();
	try {
		args = JSON.parse(args);
	} catch (ex) {
		console.error("Failed parsing query: " + ex);
		return;
	}

	var extraOptions = {}
	if (args.graphOpts) {
		extraOptions = args.graphOpts;
	}
	extraOptions.rangeSelectorHeight = 80;
	
  if (allGraphData && allGraphData.length > 0) {
  	 
	 drawGraph(graphDiv, legendDiv, allGraphData, extraOptions);
  } else {
    console.error("Query returned no results. No data to chart.");
  }
	hideOverlay();
}

var loadGraphFromArguments = function() {
	
	try {if (queryArgs.names) queryArgs.names = JSON.parse(queryArgs.names); } catch (ex) {}
	try {if (queryArgs.components) queryArgs.components = JSON.parse(queryArgs.components); } catch (ex) {}
	try {if (queryArgs.server || queryArgs.servers) queryArgs.server = JSON.parse(queryArgs.server || queryArgs.servers); } catch (ex) {}
	try {if (queryArgs.graphOpts) queryArgs.graphOpts = JSON.parse(queryArgs.graphOpts); } catch (ex) {}
	delete queryArgs.dummy;

	var objectForDashboard = queryArgs;

	if (queryArgs.url) {
		$.ajax({
			url: queryArgs.url,
			cache: false,
			success: function(result) {
				editor.setValue(js_beautify(result));
			}
		});

		return;
	}

	if (queryArgs.from == null && queryArgs.to == null && queryArgs.url == null) {
		objectForDashboard = { 
			"id": "dash_" + new Date().toISOString().replace("T","_").replace(/:/g,"-").substring(0,19),
    		"sidebarText": "New Dashboard!",
		    "header": "My new Dashboard Header!",

		    "defaultGraphOpts": {
		       "width": 400,
		       "height": 200,
		    },

		    "graphs":[{
		    	"from": "10 minutes ago",
		    	"unit": "s",
		    	"names": ["crayon_cpu"],
		    	"servers": null,
		    	"components": null,
		    	"tailSecondsInterval": null,
		    	"graphOpts": {
		    		"title": "My new Graph!",
		    		"aggregative": "ave",
		    		linesStyles: [
		    		]
		    	}
		    }]
		}
	} 

	editor.setValue(js_beautify(JSON.stringify(objectForDashboard)));
}

//createTextAreaWithLines('txtQuery');


	</script>
</body>
<script type="text/javascript" src="../../crayon-ui.js"></script>
<script type="text/javascript">
var pageHeader = "Dashboard Designer"
if (theme != null) {
	editor.setOption("theme", theme);
}
//if (queryArgs.server) pageHeader += " > " + queryArgs.server;
setHeader(pageHeader);
loadGraphFromArguments();

</script>
</html>