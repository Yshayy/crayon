<html>
<head>
	<script type="text/javascript" src="../../jquery-1.3.2.min.js"></script>	
	<script type="text/javascript" src="../../client-graphing.js"></script>
	<script type="text/javascript" src="../../client-querying.js"></script>
	<script type="text/javascript" src="../../dygraph-combined.js"></script> 
</head>
<body>
<div id="pageBody" class="frameBody">
<table id="pageTable" cellSpacing="5" cellpadding="0" style="margin: 20px;"></table>
</div>
<div id='invisibleDiv' style='display: none; position:fixed; z-index:-1; width:0px, height:0px'></div>
</body>
<script type="text/javascript" src="../../crayon-ui.js"></script>
<script type="text/javascript">

var graphCols = 1;
var graphWidth = 600;
var graphHeight = 50;
var seriesByName = {};

var dashboard = {
}

var plotGraph = function(allGraphData, graph) {
	try {

		var pageTable = $("#pageTable");

		var seriesLinesByName = {}
		for (var seriesIndex in allGraphData) {
			var series = allGraphData[seriesIndex];
			var seriesLines = seriesLinesByName[series.n];
			if (!seriesLines) {
				seriesLinesByName[series.n] = seriesLines = [];
			}
			seriesLines.push(series);
		}

		var graphData = [];
		for (nameIndex in graph.names) {
			var seriesName = graph.names[nameIndex];
			var lines = seriesLinesByName[seriesName];
			if (lines != null && lines.length > 0) {
				graphData = graphData.concat(lines);
			}
		}

		if (cacheByDiv[graph.div.id]) {
			updateDrawnGraph(graph.div, graphData);
		} else if (graphData.length == 0) {
			console.warn("No data found for graph " + graph.dyGraphTitle);
			graph.overlayText.html("No Data");
		} else {
			drawGraph(graph.div, graph.legendDiv, graphData, graph.graphOpts);
			hideGraphOverlay(graph);
		}

	} catch (ex) {
		console.log(ex);
		graph.overlayText.html("Exception: " + ex.stack);
	}
}

var hideGraphOverlay = function(graphToQuery) {
	$(graphToQuery.overlay).css("opacity","0");
	setTimeout(function() {
		$(graphToQuery.overlay).css("display","none");
	},200);
}

var hideGraph = function(gDiv) {
	$(gDiv).css("display", "none")
}
var codeGraph = function(gDiv) {
	minigraphClicked(gDiv);
}
var refreshGraph = function(gDiv) {
	var graph = gDiv.graph;
	graph.query.queryData();
}

var minigraphClicked = function(el) {
	
	var graph = el.graph;
	
	var newQueryArgs = graph;
	var query="?dummy=1";
	try {if (newQueryArgs.from) query += "&from=" + newQueryArgs.from; } catch (ex) {}
	try {if (newQueryArgs.to) query += "&to=" + newQueryArgs.to; } catch (ex) {}
	try {if (newQueryArgs.unit) query += "&unit=" + newQueryArgs.unit; } catch (ex) {}
	try {if (newQueryArgs.names) query += "&names=" + JSON.stringify(newQueryArgs.names); } catch (ex) {}
	try {if (newQueryArgs.components) query += "&components=" + JSON.stringify(newQueryArgs.components); } catch (ex) {}
	try {if (newQueryArgs.server) query += "&server=" + JSON.stringify(newQueryArgs.server); } catch (ex) {}
	try {if (newQueryArgs.graphOpts) query += "&graphOpts=" + JSON.stringify(newQueryArgs.graphOpts); } catch (ex) {}
	//window.location.search = query;

  	var win=window.open(window.location.origin + "/designer.html" + query, '_blank');
  	win.focus();
}

var loadDashboard = function() {
	//$(pageBody).append("<div id='invisibleDiv' style='display: none; position:fixed; z-index:-1; width:0px, height:0px'></div>");
	//invisibleDivEl = $("#invisibleDiv").get()[0];

	var pageTable = $('#pageTable');
	var pageBody = $('#pageBody');
	pageTable.append('<tr id="graphs_row"><td id="graphs_cell"></td></tr>');
	var lastRow = $("#graphs_row");
	var lastCell = $("#graphs_cell");

	setHeader(dashboard.header || "Untitled (Add 'header' at the root of your dashboard JSON)");
	
	//showLoadingGraphDataOverlay()
	for (graphNum in dashboard.graphs) {
		var graph = dashboard.graphs[graphNum];

		for (key in dashboard.defaultGraphOpts) {
			if (!graph.graphOpts) graph.graphOpts = {};
			if (graph.graphOpts[key] == null) graph.graphOpts[key] = dashboard.defaultGraphOpts[key];
		}

		// We're not going to query the entire database
		if (!graph.server && !graph.components && !graph.names) {
			console.error("Skipping graph because it contains no filters. Full database querying is not allowed. At least server/components/name must be specified.");
			return;	
		}

		// Title
		var title = graph.graphOpts.title || "Untitled (Add 'title' under graphOpts)";
		var defaultHeight = 250;
		var graphWidth = graph.graphOpts.width || 500;
		var graphHeight = graph.graphOpts.height || defaultHeight;
	    graph.graphOpts.legendWidth = graph.graphOpts.legendWidth || 230;
	    if (graph.graphOpts.noLegend) graph.graphOpts.legendWidth = 0;

	    var graphHtmlToAdd = '';
		graph.graphDivString = 'graph_' + graphNum;
		graph.legendDivString = 'legend_' + graphNum;
		graph.graphAndLegendDivString = 'grpah_and_legend_' + graphNum;
		
		var graphAndLegendStyle= "";
		if (graph.graphOpts.width == "wholeLine") {
			graphAndLegendStyle += "display:block;";
			graphWidth = 100;
		}

		graphHtmlToAdd += '<div id="grpah_and_legend_' + graphNum + '" class="graphAndLegendDiv" style="' + graphAndLegendStyle + '">'

		// Graph Options Bar
		graphHtmlToAdd += '<div class="graphOptionsBar" >';
		graphHtmlToAdd += '<span style="margin-left:10px">' + title + '</span>';
		//graphHtmlToAdd += '<span class="crayonButton" onclick="hideGraph('+graph.graphAndLegendDivString+')" style="float:right;margin-right:10px">Hide</span>';
		//graphHtmlToAdd += '<span class="crayonButton" onclick="codeGraph('+graph.graphDivString+')" style="float:right;margin-right:5px">Code</span>';
		//graphHtmlToAdd += '<span class="crayonButton" onclick="refreshGraph('+graph.graphDivString+')" style="float:right;margin-right:5px">Refresh</span>';
		graphHtmlToAdd += '<span id="menuButton_' + graph.graphDivString + '" onclick="showOptionsForGraph('+
			graph.graphDivString+')" class="crayonButton" style="float:right;margin-right:10px">Options</span>';
		
		graphHtmlToAdd += '</div>';
		graphHtmlToAdd += '<div id="graphOverlay_' + graphNum + '" class="graphOverlay" style="width:' + (graphWidth + graph.graphOpts.legendWidth - 10) + '; height:' + (graphHeight - 5) + '">';
		graphHtmlToAdd += '<span id="graphOverlayText_' + graphNum + '" class="graphOverlayText">Loading</span>';
		graphHtmlToAdd += '</div>';

		// Graph and legend
		graphHtmlToAdd += '<div id="graph_' + graphNum + '" class="graphDiv" style="width:' + graphWidth + '; height:' + graphHeight + '"></div>';
		if (!graph.graphOpts.noLegend) {
			graphHtmlToAdd += '<div id="legend_' + graphNum + '" class="legendDiv"></div>';
		} 

		graphHtmlToAdd += '</div>'
		lastCell.append(graphHtmlToAdd);

		if (graph.graphOpts.noLegend) {
			graph.legendDiv = invisibleDiv;
		} else {
			graph.legendDiv = $("#" + graph.legendDivString).get()[0];
		}

		graph.dyGraphTitle = graph.graphOpts.title
		delete graph.graphOpts.title
		graph.div = $("#" + graph.graphDivString).get()[0];		
		graph.div.graph = graph;
		graph.overlay = $("#graphOverlay_" + graphNum);
		graph.overlayText = $("#graphOverlayText_" + graphNum);

		var queryGraph = function(graphToQuery) {
			if (graphToQuery.graphOpts.width == "wholeLine") {
				$(window).resize(function() { resizeGraphByDiv(graphToQuery); });
			}

			graphToQuery.query = new Query({
				dateFrom: (graphToQuery.from?graphToQuery.from:null), 
				dateTo: (graphToQuery.to?graphToQuery.to:null),
				unit: graphToQuery.unit,
				hosts: graphToQuery.server, 
				components: graphToQuery.components, // Don't filter components
				names: graphToQuery.names, // Don't filter counters
				fields: allFields, // projections, field to select
				tailSecondsInterval: graphToQuery.tailSecondsInterval,
				tailCallback: function(data) { plotGraph(data,graphToQuery); },
				callback: function(data) { 
					plotGraph(data,graphToQuery); 
				}
		    });
			graphToQuery.query.queryData();

			setTimeout(function() {
				resizeGraphByDiv(graphToQuery);
			}, 100);
		}
		queryGraph(graph);
	}
}

function resizeGraphByDiv(graphObj) {
	graphObj.graphOpts.width= $(graphObj.div.parentNode).width() - 10;
	$(graphObj.div).width(graphObj.graphOpts.width);
	$(graphObj.overlay).width(graphObj.graphOpts.width + graphObj.graphOpts.legendWidth);
	if (cacheByDiv && cacheByDiv[graphObj.div.id]) {
		cacheByDiv[graphObj.div.id].dygraph.resize(graphObj.graphOpts.width, graphObj.graphOpts.height || defaultHeight)
	}
}

function deleteDashboardForce(d) {
	$.ajax({
		url: "/deleteDashboard",
		data: "id=" + d.id,
		dataType: "json",
		cache: false,
		success: function(resultObject) {
			if (resultObject.error) {
				showAlert({OK: true, title:"Delete Failed", text:"Server Error: " + resultObject.error});
			} else {
				window.reloadDashboardList();
				window.location.href = "/";
			}
		}
	});
}

function deleteDashboard() {
	showAlert({OK: true, Cancel: true, title:"Confirm Delete", text:"Are you sure you want to delete this dashboard?", callback: 
		function(choice) {
			if (choice == "OK") {
				deleteDashboardForce(dashboard);
			}
		}});
}

function codeDashboard() {
	var win=window.open(window.location.origin + "/designer.html?url=" + queryArgs.url, '_blank');
  	win.focus();
}

if (queryArgs.url) {
	$.ajax({
		url: queryArgs.url,
		cache: false,
		success: function(result) {
			try {
				dashboard = JSON.parse(result);
			} catch (ex) {
				console.error("Dasbhoard json is invalid: " + ex.stack);
			}

			var pageTable = $("#pageTable");
			pageTable.append(
				'<tr> \
					<td class="codemirrorTopBar" style=""> \
						<span class="crayonButton" onclick="codeDashboard()"  style="margin-left:30px">Code</span> \
						<span class="crayonButton" onclick="deleteDashboard()"  style="margin-left:10px">Delete Dashboard</span> \
					</td> \
				</tr> ');

			try {
				loadDashboard();
			} catch (ex) {
				console.error("Failed loading dashboard:" + ex.stack);
			}				
		}
	});
} else if (queryArgs.dashboard) {
	try {
		dashboard = JSON.parse(queryArgs.dashboard);
		if (!dashboard.graphs) {
			var newDashboard = {
				graphs: [dashboard]
			};
		}
		dashboard = newDashboard || dashboard;
	} catch (ex) {
		console.error("Dasbhoard json is invalid: " + ex.stack);
	}

	try {
		loadDashboard();
	} catch (ex) {
		console.error("Failed loading dashboard:" + ex.stack);
	}
}

</script>
</html>